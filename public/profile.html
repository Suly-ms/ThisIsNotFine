<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>This Is (Not) Fine</h1>
        <br>
        <nav>
            <a href="/">Accueil</a>
            <a href="/search.html">Rechercher</a>
            <a href="/about.html">À Propos</a>
            <a class="btnDeconnexion" href="/api/logout">Déconnexion</a>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>Mon Profil</h2>
            <form id="profile-form">
                <label for="searchType">Je recherche:</label>
                <select id="searchType" name="searchType">
                    <option value="Stage">Stage</option>
                    <option value="Alternance">Alternance</option>
                </select>

                <label for="searchStatus">Statut:</label>
                <select id="searchStatus" name="searchStatus">
                    <option value="En recherche">En recherche</option>
                    <option value="À l'écoute">À l'écoute</option>
                    <option value="Trouvé">Trouvé</option>
                </select>

                <label for="studyDomain">Domaine d'études:</label>
                <input type="text" id="studyDomain" name="studyDomain" placeholder="Ex: Informatique, Gestion...">

                <label for="linkedin">LinkedIn:</label>
                <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/...">

                <label for="github">GitHub:</label>
                <input type="url" id="github" name="github" placeholder="https://github.com/...">

                <label for="portfolio">Portfolio / Site Web:</label>
                <input type="url" id="portfolio" name="portfolio" placeholder="https://mon-portfolio.com">

                <button type="submit">Enregistrer</button>
            </form>
            <br>
            <div class="container">
                <hr style="margin: 30px 0; border: 0; border-top: 1px solid #ccc;">

                <div style="text-align: right;">
                    <h3>Zone de Danger</h3>
                    <p style="font-size: 0.9em; color: #666;">Cette action est irréversible.</p>
                    <button id="btnDeleteAccount" style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px;">
                        Supprimer mon compte définitivement
                    </button>
                </div>
            </div>
            <div id="message" style="margin-top: 10px;"></div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const btnDelete = document.getElementById('btnDeleteAccount');
            
            if (btnDelete) {
                btnDelete.addEventListener('click', async () => {
                    // 1. Demander confirmation (Sécurité)
                    const confirmation = confirm("Êtes-vous SÛR de vouloir supprimer votre compte ? \nToutes vos données seront effacées définitivement.");
                    
                    if (!confirmation) return; // Si l'utilisateur clique Annuler, on arrête tout.

                    try {
                        // 2. Envoyer la requête DELETE
                        const response = await fetch('/api/me/profile', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            alert("Votre compte a été supprimé. Au revoir !");
                            window.location.href = '/';
                        } else {
                            alert("Erreur lors de la suppression. Veuillez réessayer.");
                        }
                    } catch (error) {
                        console.error("Erreur réseau:", error);
                        alert("Impossible de contacter le serveur.");
                    }
                });
            }

            const form = document.getElementById('profile-form');
            const messageDiv = document.getElementById('message');

            // Load profile data
            try {
                const response = await fetch('/api/me');
                if (response.ok) {
                    const user = await response.json();
                    if (user.profile) {
                        document.getElementById('searchType').value = user.profile.searchType || 'Stage';
                        document.getElementById('searchStatus').value = user.profile.searchStatus || 'En recherche';
                        document.getElementById('studyDomain').value = user.profile.studyDomain || '';
                        document.getElementById('linkedin').value = user.profile.linkedin || '';
                        document.getElementById('github').value = user.profile.github || '';
                        document.getElementById('portfolio').value = user.profile.portfolio || '';
                    }
                } else {
                    window.location.href = '/'; // Redirect to login if unauthorized
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }

            // Save profile data
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                messageDiv.textContent = 'Enregistrement...';
                messageDiv.className = '';

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/me/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        messageDiv.textContent = 'Profil mis à jour avec succès !';
                        messageDiv.style.color = 'green';
                    } else {
                        messageDiv.textContent = 'Erreur lors de la mise à jour.';
                        messageDiv.style.color = 'red';
                    }
                } catch (error) {
                    console.error('Error saving profile:', error);
                    messageDiv.textContent = 'Erreur serveur.';
                    messageDiv.style.color = 'red';
                }
            });
        });
    </script>
</body>

</html>