<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer un établissement</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>This Is (Not) Fine</h1>
        <br>
        <nav>
            <a href="/">Accueil</a>
            <a href="/profile.html">Mon Profil</a>
            <a href="/search.html">Rechercher</a>
            <a class="btnDeconnexion" href="/api/logout">Déconnexion</a>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>Créer un nouvel établissement</h2>
            <form id="create-school-form">
                <label for="school-name">Nom de l'établissement:</label>
                <input type="text" id="school-name" name="name" required>

                <label for="city-search">Ville (Recherche automatique):</label>
                <div style="position: relative;">
                    <input type="text" id="city-search" placeholder="Rechercher une ville..." autocomplete="off">
                    <ul id="city-results"
                        style="list-style: none; padding: 0; margin: 0; border: 1px solid #ccc; max-height: 150px; overflow-y: auto; display: none; position: absolute; background: white; width: 100%; z-index: 1000;">
                    </ul>
                </div>

                <input type="hidden" id="latitude" name="latitude" step="any" placeholder="0.0">
                <input type="hidden" id="longitude" name="longitude" step="any" placeholder="0.0">
                <button type="submit">Créer</button>
            </form>
            <p id="message"></p>
        </div>
    </main>
    <script>
        // Address API Integration
        const citySearchInput = document.getElementById('city-search');
        const cityResultsList = document.getElementById('city-results');
        const latInput = document.getElementById('latitude');
        const longInput = document.getElementById('longitude');

        citySearchInput.addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 3) {
                cityResultsList.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&type=municipality&limit=5`);
                const data = await response.json();

                cityResultsList.innerHTML = '';
                if (data.features && data.features.length > 0) {
                    data.features.forEach(feature => {
                        const li = document.createElement('li');
                        li.textContent = `${feature.properties.label} (${feature.properties.postcode})`;
                        li.style.padding = '8px';
                        li.style.cursor = 'pointer';
                        li.addEventListener('mouseenter', () => li.style.backgroundColor = '#f0f0f0');
                        li.addEventListener('mouseleave', () => li.style.backgroundColor = 'white');

                        li.addEventListener('click', () => {
                            latInput.value = feature.geometry.coordinates[1]; // Lat is index 1
                            longInput.value = feature.geometry.coordinates[0]; // Long is index 0
                            citySearchInput.value = feature.properties.label;
                            cityResultsList.style.display = 'none';
                        });
                        cityResultsList.appendChild(li);
                    });
                    cityResultsList.style.display = 'block';
                } else {
                    cityResultsList.style.display = 'none';
                }
            } catch (error) {
                console.error('Error fetching cities:', error);
            }
        });

        // Hide results on outside click
        document.addEventListener('click', (e) => {
            if (!citySearchInput.contains(e.target) && !cityResultsList.contains(e.target)) {
                cityResultsList.style.display = 'none';
            }
        });

        document.getElementById('create-school-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const schoolName = document.getElementById('school-name').value;
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const messageElement = document.getElementById('message');
            try {
                const response = await fetch('/api/schools', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: schoolName,
                        latitude: latitude,
                        longitude: longitude
                    }),
                });
                if (response.ok) {
                    messageElement.textContent = 'Établissement créé avec succès!';
                    messageElement.style.color = 'green';
                    document.getElementById('school-name').value = '';
                    document.getElementById('school-name').value = '';
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                    citySearchInput.value = '';
                } else {
                    const error = await response.text();
                    messageElement.textContent = `Erreur: ${error}`;
                    messageElement.style.color = 'red';
                }
            } catch (error) {
                console.error('Error creating school:', error);
                messageElement.textContent = 'Erreur lors de la création de l\'établissement.';
                messageElement.style.color = 'red';
            }
        });
    </script>
</body>

</html>